<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Juju Documentation</title>
    <script src="/wp-content/themes/ubuntu/library/js/all-yui.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,300,300italic,400italic,700,700italic|Ubuntu+Mono" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" media="screen" href="https://juju.ubuntu.com/wp-content/themes/juju-website/css/reset.css">
    <link rel="shortcut icon" href="//assets.ubuntu.com/sites/ubuntu/latest/u/img/favicon.ico" />
    <link rel="stylesheet" type="text/css" media="screen" href="//assets.ubuntu.com/sites/guidelines/css/latest/ubuntu-styles.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="//assets.ubuntu.com/sites/ubuntu/latest/u/css/global.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://juju.ubuntu.com/wp-content/themes/juju-website/css/960.css">
    <link rel="stylesheet" type="text/css" media="screen" href="https://juju.ubuntu.com/wp-content/themes/juju-website/css/home-new.css">
    <link rel="stylesheet" id="stacktack-css" href="https://juju.ubuntu.com/wp-content/plugins/stacktack/css/stacktack.min.css?ver=3.4.2" type="text/css" media="all">
    <link href="./css/main.css" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script type="text/javascript" src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="resources">
    <header class="banner global" role="banner">
      <nav role="navigation" class="nav-primary nav-right">
        <div class="logo">
          <a class="logo-ubuntu" href="https://juju.ubuntu.com/">
            <img width="118" height="27" src="//assets.ubuntu.com/sites/ubuntu/latest/u/img/logo.png" alt="Juju logo" />
            <span>Juju</span>
          </a>
        </div>
        <ul>
          <li class="accessibility-aid"><a accesskey="s" href="#main-content">Jump to content</a></li>
          <li class="page_item page-item-8"><a href="https://juju.ubuntu.com/charms/">Charms</a></li>
          <li class="page_item page-item-10"><a href="https://juju.ubuntu.com/features/">Features</a></li>
          <li class="page_item page-item-12"><a href="https://juju.ubuntu.com/deployment/">Deploy</a></li>
          <li class="page_item page-item-14"><a href="https://juju.ubuntu.com/resources/">Resources</a></li>
          <li class="page_item page-item-16"><a href="https://juju.ubuntu.com/community/">Community</a></li>
          <li class="page_item page-item-18"><a href="https://juju.ubuntu.com/download/">Install Juju</a></li>
        </ul>
        <div id="box-search">
          <form class="search-form" method="get" id="searchform" action="https://juju.ubuntu.com/">
            <label class="off-left" for="s">Search:</label>
            <input class="form-text" type="text" value="" name="s" id="s" />
            <button class="off-left form-submit" type="submit" id="searchsubmit">Search</button>
          </form>
        </div>
      </nav>
    </header>
    <div class="wrapper">
      <div id="main-content" class="inner-wrapper" role="main">
        <div class="row no-border">
         <div class="header-navigation-secondary"></div>
         <h2 class="pagetitle">Juju documentation</h2>
        </div>
        <section id="content" class="container-12">
          <div class="grid-12 doc-container">
            <div id="navlinks" class="grid-3 doc-navigation">
                          <h1>User Guide</h1>
            <ul class="no-margin">
              <li class=""><a href="getting-started.html">Getting Started</a></li>
              <li class=" sub"><a href="config-aws.html">Amazon Web Service</a></li>
              <li class=" sub"><a href="config-azure.html">Windows Azure</a></li>
              <li class=" sub"><a href="config-hpcloud.html">HP Public Cloud</a></li>
              <li class=" sub"><a href="config-joyent.html">Joyent</a></li>
              <li class=" sub"><a href="config-openstack.html">OpenStack</a></li>
              <li class=" sub"><a href="config-maas.html">MAAS (bare metal)</a></li>
              <li class=" sub"><a href="config-local.html">Local</a></li>
              <li class=" sub"><a href="config-vagrant.html">Vagrant</a></li>
              <li class=" sub"><a href="config-manual.html">Manual Provisioning</a></li>
              <li class=" sub"><a href="getting-started.html#test">Testing your setup</a></li>
              <li class=""><a href="charms.html">Using Charms</a></li>
              <li class=" sub"><a href="charms-deploying.html">Deploying Services</a></li>
              <li class=" sub"><a href="charms-constraints.html">Using constraints</a></li>
              <li class=" sub"><a href="charms-config.html">Service Configuration</a></li>
              <li class=" sub"><a href="charms-relations.html">Service Relationships</a></li>
              <li class=" sub"><a href="charms-exposing.html">Exposing Services</a></li>
              <li class=" sub"><a href="charms-scaling.html">Scaling Services</a></li>
              <li class=" sub"><a href="charms-service-groups.html">Groups of Services</a></li>
              <li class=" sub"><a href="charms-destroy.html">Destroying Services</a></li>
              <li class=" sub"><a href="charms-environments.html">Managing environments</a></li>
              <li class=" sub"><a href="charms-bundles.html">Using bundles</a></li>
              <li class=""><a href="howto.html">How to...</a></li>
              <li class=" sub"><a href="howto-node.html">Deploy a Node.js app</a></li>
              <li class=" sub"><a href="howto-rails.html">Test and deploy on Rails</a></li>
              <li class=" sub"><a href="howto-backup-restore.html">Backup and Restore</a></li>
              <li class=" sub"><a href="howto-gui-management.html">Manage Juju with the GUI</a></li>
              <li class=" sub"><a href="howto-privatecloud.html">Set up a Private Cloud</a></li>
              <li class=" sub"><a href="howto-proxies.html">Configure Proxy Access</a></li>
              <li class="sub"><a href="howto-vagrant-workflow.html">Vagrant Workflow</a></li>
              <li class="sub"><a href="howto-authorised-keys.html">Manage Authorised Keys</a></li>
              <li class=""><a href="troubleshooting-local.html">Troubleshooting</a></li>
            </ul>
            <h1>Charm Authors</h1>
            <ul class="no-margin">
              <li class=""><a href="authors-intro.html">Getting started</a></li>
              <li class=""><a href="authors-charm-components.html">Components of a charm</a></li>
              <li class=" sub"><a href="authors-charm-metadata.html">metadata.yaml</a></li>
              <li class=" sub"><a href="authors-charm-hooks.html">/hooks</a></li>
              <li class=" sub"><a href="authors-charm-config.html">config.yaml</a></li>
              <li class=""><a href="authors-charm-writing.html">Charm walkthrough</a></li>
              <li class=" sub"><a href="authors-hook-environment.html">How hooks are run</a></li>
              <li class=" sub"><a href="authors-relations-in-depth.html">Relations lifecycle</a></li>
              <li class=" sub"><a href="authors-charm-interfaces.html">Implementing interfaces</a></li>
              <li class=" sub"><a href="authors-hook-errors.html">Hook Errors</a></li>
              <li class=" sub"><a href="authors-hook-debug.html">Hook Debugging</a></li>
              <li class="sub"><a href="authors-subordinate-services.html">Subordinate services</a></li>
              <li class="sub"><a href="authors-implicit-relations.html">Implicit Relations</a></li>
              <li class="sub"><a href="authors-testing.html">Charm Testing</a></li>


              <li class=""><a href="authors-charm-store.html">The Juju Charm Store</a></li>
              <li class=" sub"><a href="authors-charm-store.html#submitting">Submit a charm</a></li>
              <li class=" sub"><a href="authors-charm-policy.html">Charm store policy</a></li>
              <li class=" sub"><a href="authors-charm-best-practice.html">Best practices</a></li>
              <li class=" sub"><a href="authors-charm-quality.html">Charm Feature Rating</a></li>
              <li class=" sub"><a href="authors-charm-icon.html">Charm Icons</a></li>
            </ul>

            <h1>Tools</h1>
            <ul class="no-margin">
              <li class=""><a href="tools-charm-tools.html">Charm Tools</a></li>
              <li class=""><a href="tools-amulet.html">Amulet</a></li>
            </ul>

            <h1>Reference</h1>
            <ul class="no-margin">
              <li class="sub"><a href="commands.html">Juju commands</a></li>
              <li class="sub"><a href="reference-constraints.html">Juju constraints</a></li>
              <li class="sub"><a href="reference-release-notes.html">Release notes</a></li>
              <li class="sub"><a href="glossary.html">Glossary</a></li>
              <li class="sub"><a href="reference-reviewers.html">Charm Review Criteria</a></li>
              <li class="sub"><a href="contributing.html">Contribute to the Docs!</a></li>
            </ul>
            </div>
            <div class="grid-9 doc-content">
              <article>
                <h1 id="using-juju-to-deploy-your-node.js-application">Using Juju to Deploy your Node.js Application</h1>
<p>One of Juju's main use cases is to deploy your application directly out of
version control and into a cloud. Since Juju supports local and remote clouds,
this makes for a nice workflow that enables you to rev your app quickly on your
local machine and then deploy to the cloud.</p>
<p>In this tutorial we will deploy a Node.js/MongoDB application directly from
github. The application will be behind an HAProxy service so that we can
horizontally scale when needed.</p>
<p>We will then set up a local-to-cloud workflow with our application so we can do
continuous deployment. Since we deploy locally in the exact same way as we
deploy to a cloud, this is a powerful method for developing your application in
an environment that more closely resembles production.</p>
<p>Before moving on you should have gone through the <a href="https://juju.ubuntu.com/docs/getting-started.html">Getting
Started</a> section and
installed and configured Juju.</p>
<h2 id="basic-usage-of-the-node.js-charm">Basic Usage of the Node.js Charm</h2>
<p>First, create a configuration file <code>myapp.yaml</code> to add info about your app
pointing to your github repo:</p>
<pre><code>sample-node:
  repo: https://github.com/yourapplication
</code></pre>
<p>If you have not already bootstrapped an environment, do so:</p>
<pre><code>juju bootstrap
</code></pre>
<p>Then wait a few minutes while your cloud spins up. Then deploy some basic
services:</p>
<pre><code>juju deploy --config myapp.yaml node-app myapp
juju deploy mongodb
juju deploy haproxy
</code></pre>
<p>relate them</p>
<pre><code>juju add-relation mongodb myapp
juju add-relation myapp haproxy
</code></pre>
<p>open it up to the outside world</p>
<pre><code>juju expose haproxy
</code></pre>
<p>Find the haproxy instance's public URL from</p>
<pre><code>juju status
</code></pre>
<p>(or attach it to an elastic IP via the AWS console) and open it up in a browser.</p>
<p>scale up your app (to 10 nodes for example)</p>
<pre><code>juju add-unit -n 10 myapp
</code></pre>
<p>and scale it back down</p>
<pre><code>juju remove-unit myapp/9 myapp/8 myapp/7 myapp/6 myapp/5 myapp/4 myapp/3 myapp/2 myapp/1
</code></pre>
<h2 id="local-to-cloud-workflow">Local to Cloud Workflow</h2>
<p>The previous example deploys your application quickly to the cloud, in this
example we will show how to hack and test on an application locally on your
laptop and then push out to the public cloud.</p>
<p>We need to configure 2 environments, a local one and a public cloud one.</p>
<ol>
<li>Configure the <a href="https://juju.ubuntu.com/docs/config-local.html">local provider</a> on your machine. </li>
<li>Configure a public or private cloud on your machine. </li>
<li><a href="https://juju.ubuntu.com/docs/config-aws.html">AWS</a></li>
<li><a href="https://juju.ubuntu.com/docs/config-hpcloud.html">HP Cloud</a></li>
<li><a href="https://juju.ubuntu.com/docs/config-openstack.html">OpenStack</a></li>
</ol>
<p>In this example the local environment is named <code>local</code> and we'll deploy to an
AWS environment called <code>amazon</code>. First let's <code>switch</code> to the local environment
and bootstrap.</p>
<pre><code>juju switch local
juju bootstrap
</code></pre>
<p>Create a configuration file <code>myapp.yaml</code> to add info about your app pointing to
your github repo:</p>
<pre><code>sample-node:
  app_url: https://github.com/yourapplication
</code></pre>
<p>Then deploy some basic services:</p>
<pre><code>juju deploy --config ~/myapp.yaml node-app myapp 
juju deploy mongodb
</code></pre>
<p>relate them</p>
<pre><code>juju add-relation mongodb myapp
</code></pre>
<p>Now open up your browser and go to <code>http://localhost</code> to get your application
loaded in your browser.</p>
<h3 id="continuous-deployment">Continuous Deployment</h3>
<p>Continue to write your code, push to git as you land features and fixes. When
you're ready to test it you can tell Juju to check the git repository again:</p>
<pre><code>juju set myapp app_branch=https://github.com/yourapplication
</code></pre>
<p>The charm will then fetch the latest code and you can refresh your browser at
<code>http://localhost</code>.</p>
<p>Repeat pushing to git and using the juju set command to keep a live instance of
your application running in your local environment.</p>
<h3 id="push-to-your-public/private-cloud">Push to your Public/Private Cloud</h3>
<p>After you've repeatedly upgraded your application locally it's time to push it
out to a place where your coworkers can see your app in all it's glory, let's
push this to AWS. Same exact commands as before, just to a different
environment:</p>
<pre><code>juju switch amazon
juju bootstrap
juju deploy --config ~/myapp.yaml node-app myapp 
juju deploy mongodb
juju add-relation mongodb myapp
</code></pre>
<p>Since we're on a public cloud and not on a local provider we need to explicitly
expose the service and get its public IP:</p>
<pre><code>juju expose myapp
juju status myapp
</code></pre>
<p>And put the ec2 URL in your browser. If you want to enable some horizontal
scalability to your application you can do so, even after you've deployed!</p>
<pre><code>juju deploy haproxy
juju add-relation haproxy myapp
juju expose haproxy
juju unexpose myapp
</code></pre>
<p>And then get the public IP from the haproxy instead (notice how we've unexposed
your application so that only haproxy is serving the public internet):</p>
<pre><code>juju status haproxy
</code></pre>
<p>Now you can <code>juju add-unit myapp</code> and <code>juju remove-unit myapp</code> based on load.</p>
<h3 id="tearing-it-all-down">Tearing it all down</h3>
<p>The local containers survive reboots and do not go away until you explicitly
tear the environment down. Now that your coworkers have seen your great
application let's also stop spending money:</p>
<pre><code>juju destroy-environment -e amazon
juju destroy-environment -e local
</code></pre>
<h2 id="charm-details">Charm Details</h2>
<p>This section is to explain how the charm works and is provided here as a
reference.</p>
<h3 id="what-the-charm-does">What the charm does</h3>
<p>During the <code>install</code> hook,</p>
<ul>
<li>installs <code>node</code>/<code>npm</code></li>
<li>clones your node app from the repo specified in <code>app_repo</code></li>
<li>runs <code>npm</code> if your app contains <code>package.json</code></li>
<li>configures networking if your app contains <code>config/config.js</code></li>
<li>waits to be joined to a <code>mongodb</code> service </li>
</ul>
<p>when related to a <code>mongodb</code> service, the formula</p>
<ul>
<li>configures db access if your app contains <code>config/config.js</code></li>
<li>starts your node app as a service </li>
</ul>
<h3 id="charm-configuration">Charm configuration</h3>
<p>Configurable aspects of the charm are listed in <code>config.yaml</code> and can be set by
either editing the default values directly in the yaml file or passing a
<code>myapp.yaml</code> configuration file during deployment</p>
<pre><code>juju deploy --config ~/myapp.yaml node-app myapp
</code></pre>
<p>Some of these parameters are used directly by the charm, and some are passed
through to the node app using <code>config/config.js</code>.</p>
<h3 id="application-configuration">Application configuration</h3>
<p>The formula looks for <code>config/config.js</code> in your app which starts off looking
something like this</p>
<pre><code>module.exports = config = {
  "name" : "mynodeapp"
  ,"listen_port" : 8000
  ,"mongo_host" : "localhost"
  ,"mongo_port" : 27017
}
</code></pre>
<p>and gets modified with contextually correct configuration information during
either deployment (via the <code>install</code> hook) or relation to another service
(<code>relation-changed</code> hook).</p>
<p>This config can be used from within your application using snippets like</p>
<pre><code>...
var config = require('./config/config')
...
new mongo.Server(config.mongo_host, config.mongo_port, {}),
...
server.listen(config.listen_port);
...
</code></pre>
<p>Alternatively you could use a <code>Procfile</code> in root directory like this:</p>
<pre><code>web: node app.js
</code></pre>
<p>and then get the environment variables from the running environment like this:</p>
<pre><code>app.set('port', process.env.PORT);
</code></pre>
<p>The defined environment variables are:</p>
<pre><code>NAME
PORT
NODE_ENV
MONGO_HOST
MONGO_PORT
MONGO_REPLSET
</code></pre>
<h3 id="network-access">Network access</h3>
<p>This charm does not open any public ports itself. The intention is to relate it
to a proxy service like <code>haproxy</code>, which will in turn open port 80 to the
outside world. This allows for instant horizontal scalability.</p>
<p>If your node app is itself a proxy and you want it directly exposed, this can
easily be done by adding</p>
<pre><code>open-port $app_port
</code></pre>
<p>to the bottom of the <code>install</code> hook, and then once your stack is started, you
expose</p>
<pre><code>juju expose myapp
</code></pre>
<p>it to the outside world.</p>
<p>By default, juju services within the same environment can talk to each other on
any port over internal network interfaces.</p>
<h3 id="making-this-work-with-your-node.js-app">Making this work with your node.js app</h3>
<p>This charm makes some strong assumptions about the structure of the node
application (<code>config/config.js</code>) that might not apply to your app. Please treat
this formula as a template that you can fork and modify to suit your needs.</p>
<p>The biggest difference between how the charm behaves for different kind of apps
is application startup. A simple application will want to start upon install
(startup code goes in the <code>install</code> hook), whereas some applications will not
want to start up until a database has be associated (startup code goes in the
<code>db-relation-joined</code> hooks).</p>
              </article>
            </div>
          </div>
        </section>
      </div>
    </div>
    <footer class="global clearfix" role="contentinfo">
      <nav role="navigation">
        <div class="footer-a">
          <div class="clearfix">
            <ul>
             <li>
               <h2><a href="/">Juju</a></h2>
               <ul>
                 <li><a href="/charms">Charms</a></li>
                 <li><a href="/features">Features</a></li>
                 <li><a href="/deployment">Deployment</a></li>
               </ul>
             </li>
             <li>
               <h2><a href="/resources">Resources</a></h2>
               <ul>
                 <li><a href="/resources/juju-overview/">Overview</a></li>
                 <li><a href="/docs/">Documentation</a></li>
                 <li><a href="/resources/the-juju-gui/">The Juju web UI</a></li>
                 <li><a href="/docs/authors-charm-store.html">The charm store</a></li>
                 <li><a href="/docs/getting-started.html#test">Tutorial</a></li>
                 <li><a href="/resources/videos/">Videos</a></li>
                 <li><a href="/resources/easy-tasks-for-new-developers/">Easy tasks for new developers</a></li>
               </ul>
             </li>
             <li>
               <h2><a href="/community">Community</a></h2>
                 <ul>
                   <li><a href="/community/blog/">Juju Blog</a></li>
                   <li><a href="/events/">Events</a></li>
                   <li><a href="/community/weekly-charm-meeting/">Weekly charm meeting</a></li>
                   <li><a href="/community/charmers/">Charmers</a></li>
                   <li><a href="/docs/authors-charm-writing.html">Write a charm</a></li>
                   <li><a href="/docs/contributing.html">Help with documentation</a></li>
                   <li><a href="https://bugs.launchpad.net/juju-core/+filebug">File a bug</a></li>
                   <li><a href="/labs/">Juju Labs</a></li>
                 </ul>
               </li>
               <li>
                 <h2><a href="https://jujucharms.com/sidebar/">Try Juju</a></h2>
                 <ul>
                   <li><a href="https://jujucharms.com/">Charm store</a></li>
                   <li><a href="/download/">Download Juju</a></li>
                 </ul>
               </li>
             </ul>
           </div>
         </div>
       </nav>
       <div class="legal clearfix">
         <p>&copy; 2013 Canonical Ltd. Ubuntu and Canonical are registered trademarks of <a href="http://canonical.com">Canonical Ltd</a>.</p>
       </div>
     </footer>
     <script src="//google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>
     <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
     <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
     <script src="//d38yea5fb4e2oh.cloudfront.net/jquery.stacktack.min.js"></script>
     <script type="text/javascript" src="//code.jquery.com/jquery-1.9.1.js"></script>
     <script type="text/javascript" src="./js/main.js"></script>
     <script type="text/javascript" src="./js/jquery.details.js"></script>
     <script src="//assets.ubuntu.com/sites/ubuntu/latest/u/js/core.js"></script>
     <script src="//assets.ubuntu.com/sites/ubuntu/latest/u/js/global.js"></script>
     <!-- google analytics -->
     <script>
       var _gaq = _gaq || [];
       _gaq.push(['_setAccount', 'UA-1018242-41']);
       _gaq.push(['_trackPageview']);

       (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();
    </script>
  </body>
</html>
